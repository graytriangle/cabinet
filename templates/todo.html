<script>
function goal_toggle(event) {
    var children = event.target.parentNode.getElementsByClassName("goal_childgroup")[0];
    event.target.classList.toggle('hiddengoal');
    if (children.style["display"] == "none") {
        children.style["display"] = "block";
    } else {
        children.style["display"] = "none";
    }
}

function goal_settings(event, show) {
    if (event.target.classList.contains('todo_task')) {
        var el = event.target;
    } else {
        var el = findAncestor(event.target, 'todo_task');
    }
    /* hide/show icons that are immediate children of a target div */
    var icgroup = el.getElementsByClassName("goalname")[0].getElementsByClassName("settinggroup")[0].getElementsByClassName("goalsetting");
    for (var i = 0; i < icgroup.length; i++) {
        if (show) {
            icgroup[i].style["display"] = "block";
        } else {
            icgroup[i].style["display"] = "none";
        }
    }
}
</script>

<div class="todo">
    <div class="todo_title">Задачи</div>
    {% for record in todo recursive %}
        {% set active = False %}
        {% if record.children and not record.finished %}
            {% set active = True %}
        {% endif %}
        <div class="todo_task {% if loop.depth == 1 %} toptask {% else %} childtask {% endif %}">
            <div 
                class="todoicon goalgroup {% if not active %} graygoal {% endif %} " 
                {% if active %} onclick="goal_toggle(event)" {% endif %}>
            </div>
            <div class="goalname {% if record.finished %} goalname_done {% endif %}" onmouseover="goal_settings(event, true)" onmouseout="goal_settings(event, false)">
                {{record.name -}}
                <div class="settinggroup">
                    {% if not record.finished %}
                        <div class="todoicon goalsetting editgoal"></div>
                        <div class="todoicon goalsetting addgoal"></div>
                    {% endif %}
                    <div class="todoicon goalsetting checkgoal"></div>
                </div>
            </div>
            {% if active %}
                <div class="goal_childgroup">
                {{ loop(record.children) }}
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>